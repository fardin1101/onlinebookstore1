name: Deploy to Tomcat via ngrok

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WAR
        run: mvn clean package

      - name: Install ngrok
        run: |
          curl -s https://api.ngrok.com/v2/versions/download -H "Ngrok-Edition: oss" -H "Ngrok-Version: 3" -H "Ngrok-OS: linux" -H "Ngrok-Arch: amd64" | jq -r '.download_url' | wget -O ngrok.tgz
          tar xvzf ngrok.tgz
          chmod +x ngrok
          sudo mv ngrok /usr/local/bin/

      - name: Authenticate & start ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          ngrok config add-authtoken $NGROK_AUTHTOKEN
          ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
          echo "Waiting for tunnel..."
          sleep 12

      - name: Get ngrok public URL
        id: ngrok
        run: |
          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.proto=="https") | .public_url')
          echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
          echo "Deploying via $URL"

      - name: Deploy WAR to Tomcat
        run: |
          curl -v --upload-file target/*.war \
            "${{ steps.ngrok.outputs.ngrok_url }}/manager/text/deploy?path=/obstore&update=true" \
            -u admin:root123
